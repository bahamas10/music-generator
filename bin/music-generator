#!/usr/bin/env node
/*
 * CLI wrapper for the music generator (Song class)
 *
 * Dave Eddy August 30th 2021
 */

var assert = require('assert-plus');
var getopt = require('posix-getopt');

var Song = require('../lib/song.js').Song;

// default options, overridden by CLI opts
var opts = {
    bpm: 60,
    beatsPerBar: 4,
    transpose: 12,
    leftHandRange: {
        root: 7,
        min: 0,
        max: 14
    },
    rightHandRange: {
        min: 14,
        max: 28
    },
    velocityRange: {
        min: 25,
        max: 47
    },
    sectionLengths: {
        leftHand: 4,
        rightHand: 8
    }
};

function parseRange(s, c) {
    assert.string(s, 's');
    assert.string(c, 'c');

    var spl = s.split(c);

    assert.equal(spl.length, 2, 'invalid range');

    var n = spl.map(function (num) {
        var parsed = parseInt(num, 10);
        assert.number(parsed, 'parsed');
        return parsed;
    });

    assert.arrayOfNumber(n, 'n');

    return n;
}

function main() {
    var options = [
        'b:(bpm)',
        'B:(beats-per-bar)',
        'L:(left-hand-range)',
        'r:(root)',
        'R:(right-hand-range)',
        'S:(section-lengths)',
        't:(transpose)',
        'V:(velocity-range)',
    ].join('');
    var parser = new getopt.BasicParser(options, process.argv);

    var n;
    var option;
    var leftHandRange = null;
    var rightHandRange = null;
    var sectionLengths = null;
    var velocityRange = null;
    while ((option = parser.getopt()) !== undefined) {
        switch (option.option) {
            case 'b': opts.bpm = parseInt(option.optarg, 10); break;
            case 'B': opts.beatsPerBar = parseInt(option.optarg, 10); break;
            case 'L': leftHandRange = option.optarg; break;
            case 'r': opts.leftHandRange.root = parseInt(option.optarg, 10); break;
            case 'R': rightHandRange = option.optarg; break;
            case 'S': sectionLengths = option.optarg; break;
            case 't': opts.transpose = parseInt(option.optarg, 10); break;
            case 'V': velocityRange = option.optarg; break;
            default: throw 'bad argument';
        }
    }
    var args = process.argv.slice(parser.optind());

    var pattern = args[0];

    if (!pattern) {
        console.error('usage: music-generator [opts] <pattern-string>');
        process.exit(1);
    }
    opts.pattern = pattern;

    if (velocityRange) {
        n = parseRange(velocityRange, '-');
        opts.velocityRange.min = n[0];
        opts.velocityRange.max = n[1];
    }

    if (sectionLengths) {
        n = parseRange(sectionLengths, ',');
        opts.sectionLengths.leftHand = n[0];
        opts.sectionLengths.rightHand = n[1];
    }

    if (leftHandRange) {
        n = parseRange(leftHandRange, '-');
        opts.leftHandRange.min = n[0];
        opts.leftHandRange.max = n[1];
    }

    if (rightHandRange) {
        n = parseRange(rightHandRange, '-');
        opts.rightHandRange.min = n[0];
        opts.rightHandRange.max = n[1];
    }

    console.error(opts);

    var song = new Song(opts);

    console.log(song.getMidiData());
}

main();
